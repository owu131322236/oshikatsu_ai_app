<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Canvas Image Upload</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
	<input type="file" id="imageInput" accept="image/*">
    <img id="im" width=640 height=360><br>
        
    <canvas id="myCanvas" style="display:none"></canvas><br>
    <input type="text" id="txt" value="図の内容について日本語で回答してください" size=50>
    <button id="start">send</button>
	<div id="answer">返信内容</div>
	
<script>
    // 初期設定
    var canvas = document.getElementById('myCanvas');
    var ctx = canvas.getContext('2d');
    var img = document.getElementById("im");

	// 画像ファイルが選択された時の処理
    $('#imageInput').on('change', function(event) {
	    const file = event.target.files[0];

        if (file && file.type.startsWith('image/')) {
            // 画像ファイルのObject URLを生成して<img>に設定
            img.src = URL.createObjectURL(file);
		}
    });
    

    // sendボタンがクリックされた時の処理
    $('#start').on('click', function() {
    // canvasのサイズを画像の「本来の」サイズに合わせる
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;

        // canvasに画像を描画
        ctx.drawImage(img, 0, 0);
        
        var imageData = canvas.toDataURL('image/png');
        var base64Data = imageData.replace(/^data:image\/png;base64,/, "");

		var txt = $('#txt').val();

        // サーバーに送信
        $.ajax({
            type: 'POST',
            url: 'upload',  // サーバー側のurl
            data: {
                "imgurl": base64Data, "prompt": encodeURIComponent(txt)
            },
            success: function(response) {
            
            	//ここに自分のプログラムを記述する！！
            	//サーバーからの返答が変数responseに入っている
            	
                $('#answer').html(response);
            },
            error: function() {
                alert('失敗しました');
            }
        });

	});

</script>

</body>
</html>
